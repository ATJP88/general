name: "CI Workflow for Microservices"

on:
  push:
    branches:
      - main
      - feature/*
      - release/*
      - chore/*
      - feat/*
  workflow_dispatch:

env:  # non-sensitive repo configs
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  REPO_NAME: ${{ vars.GCP_REPO_NAME }}

jobs:
  sqscan:
    name: SonarQube Multi-Language Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # ---------- Java (adservice) ----------
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build Java service (adservice)
        run: |
          if [ -f "adservice/build.gradle" ] || [ -f "adservice/gradlew" ]; then
            cd adservice
            chmod +x gradlew || true
            ./gradlew build -x test
            cd ..
          elif [ -f "adservice/pom.xml" ]; then
            cd adservice
            mvn clean install -DskipTests
            cd ..
          fi

      # ---------- Go (frontend, productcatalogservice, shippingservice, checkoutservice) ----------
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Go services
        run: |
          for svc in frontend productcatalogservice shippingservice checkoutservice; do
            if [ -d "$svc" ] && [ -f "$svc/go.mod" ]; then
              echo "ðŸ“¦ Building Go service: $svc"
              cd $svc
              go build ./...
              cd ..
            fi
          done

      # ---------- Node.js (currencyservice, paymentservice) ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node.js deps
        run: |
          for svc in currencyservice paymentservice; do
            if [ -d "$svc" ] && [ -f "$svc/package.json" ]; then
              echo "ðŸ“¦ Installing Node.js deps for $svc"
              cd $svc
              npm install --ignore-scripts --no-audit
              cd ..
            fi
          done

      # ---------- Python (emailservice, recommendationservice, loadgenerator) ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          for svc in emailservice recommendationservice loadgenerator; do
            if [ -d "$svc" ] && [ -f "$svc/requirements.txt" ]; then
              echo "ðŸ“¦ Installing Python deps for $svc"
              pip install -r $svc/requirements.txt || true
            fi
          done

      # ---------- C# (cartservice) ----------
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build C# service (cartservice)
        run: |
          if [ -d "cartservice" ] && ls cartservice/*.csproj >/dev/null 2>&1; then
            cd cartservice
            dotnet restore
            dotnet build --no-restore
            cd ..
          fi

      # ---------- SonarQube Scan ----------
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=hipster
            -Dsonar.projectName=hipster
            -Dsonar.sources=.
            -Dsonar.java.binaries=adservice/build/classes,adservice/target/classes
            -Dsonar.exclusions=**/lightstep-opentelemetry-javaagent-*.jar
      
      # If you wish to fail your job when the Quality Gate is red, uncomment the
      # following lines. This would typically be used to fail a deployment.
      # - uses: sonarsource/sonarqube-quality-gate-action@master
      #   timeout-minutes: 5
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    strategy:
      matrix:
        service: 
          - adservice
          - cartservice
          - checkoutservice
          - currencyservice
          - emailservice
          - frontend
          - loadgenerator
          - paymentservice
          - productcatalogservice
          - recommendationservice
          - shippingservice

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v0.4.0
        with:
          token_format: access_token
          workload_identity_provider: ${{ secrets.GCP_WI_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Login to Artifact Registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Get short commit ID
        id: get-tag
        run: echo "commit_id=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Build and Push ${{ matrix.service }}
        run: |
          IMAGE_URI=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ matrix.service }}:${{ env.commit_id }}

          echo "ðŸš€ Building $IMAGE_URI"
          docker build -t $IMAGE_URI ./${{ matrix.service }}
          docker push $IMAGE_URI

          # Update deployment manifest for this service
          sed -i "s|image: .*|image: $IMAGE_URI|" ./k8s/${{ matrix.service }}.yaml
