#!/bin/bash

set -e

# Define variables
CONTAINER_REGISTRY='asia-docker.pkg.dev/hsbc-12514600-fdscshk-dev/fdscs'
NEXUS_REPO='nexus3.systems.uk.hsbc:18080/hsbc-12514600-fdscshk-dev/test'

# Ensure Kubernetes context is set correctly
gcloud config set project your-gcp-project-id
gcloud container clusters get-credentials your-cluster-name --zone your-cluster-zone

# Authenticate Docker to Nexus and GCP Artifact Registry
echo "$NEXUS_USERNAME" | docker login $NEXUS_REPO --username $NEXUS_USERNAME --password-stdin
gcloud auth configure-docker $CONTAINER_REGISTRY

# Read the deploy_images.txt file
if [ ! -f /tmp/deploy_images.txt ]; then
    echo "No images to deploy. Exiting."
    exit 0
fi

while read -r line; do
    API_NAME=$(echo $line | awk '{print $1}')
    IMAGE_TAG=$(echo $line | awk '{print $2}')

    NEXUS_IMAGE="$NEXUS_REPO/$API_NAME:$IMAGE_TAG"
    GCP_IMAGE="$CONTAINER_REGISTRY/$API_NAME:$IMAGE_TAG"

    echo "Pulling image $NEXUS_IMAGE from Nexus"
    docker pull $NEXUS_IMAGE

    echo "Tagging image as $GCP_IMAGE"
    docker tag $NEXUS_IMAGE $GCP_IMAGE

    echo "Pushing image to GCP Artifact Registry"
    docker push $GCP_IMAGE

    echo "Removing local image $NEXUS_IMAGE"
    docker rmi $NEXUS_IMAGE $GCP_IMAGE

    echo "Updating Kubernetes deployment for $API_NAME to use image $GCP_IMAGE"

    if [ "$API_NAME" == "aggregate-api" ]; then
        kubectl set image deployment/deployment-aggregate-api aggregate-api=$GCP_IMAGE
        echo "deployment.apps/deployment-aggregate-api image updated"
    elif [[ "$API_NAME" == "filenet-api" ]]; then
        for i in {1..5}; do
            kubectl set image deployment/deployment-filenetapi-$i filenetapi-$i=$GCP_IMAGE
            echo "deployment.apps/deployment-filenetapi-$i image updated"
        done
    elif [ "$API_NAME" == "arc-api" ]; then
        kubectl set image deployment/deployment-arc-api arc-api=$GCP_IMAGE
        echo "deployment.apps/deployment-arc-api image updated"
    else
        echo "Unknown API_NAME: $API_NAME. Skipping."
    fi
done < /tmp/deploy_images.txt

echo "All Kubernetes deployments updated successfully."
