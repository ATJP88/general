#!/bin/bash

set -e

# Define variables
CONTAINER_REGISTRY='asia-docker.pkg.dev/hsbc-12514600-fdscshk-dev/fdscs'
NEXUS_REPO='nexus3.systems.uk.hsbc:18080/hsbc-12514600-fdscshk-dev/test'
BUILD_NUMBER=${BUILD_NUMBER:-latest}  # Use provided BUILD_NUMBER or default to 'latest'

# Authenticate Docker to Nexus and GCP Artifact Registry
echo "$NEXUS_USERNAME" | docker login $NEXUS_REPO --username $NEXUS_USERNAME --password-stdin
gcloud auth configure-docker $CONTAINER_REGISTRY

# Read the deploy_images.txt file
if [ ! -f /tmp/deploy_images.txt ]; then
    echo "No images to deploy. Exiting."
    exit 0
fi

while read -r line; do
    API_NAME=$(echo $line | awk '{print $1}')
    IMAGE_TAG=$(echo $line | awk '{print $2}')

    NEXUS_IMAGE="$NEXUS_REPO/$API_NAME:$IMAGE_TAG"
    GCP_IMAGE="$CONTAINER_REGISTRY/$API_NAME:$IMAGE_TAG"

    echo "Pulling image $NEXUS_IMAGE from Nexus"
    docker pull $NEXUS_IMAGE

    echo "Tagging image as $GCP_IMAGE"
    docker tag $NEXUS_IMAGE $GCP_IMAGE

    echo "Pushing image to GCP Artifact Registry"
    docker push $GCP_IMAGE

    echo "Removing local image $NEXUS_IMAGE"
    docker rmi $NEXUS_IMAGE
done < /tmp/deploy_images.txt

echo "All Docker operations completed successfully."
